<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <style>
    #field {
    background-color: black;
        height: 70vh;
    }
    
    .border {
        width: 90%;
        margin-left: auto;
        margin-right: auto;
        margin-top: 5%;
        border: 1px solid red;
    }

    .gravity {
        fill: #000;
        stroke:#fff;
        stroke-width:0.05;
    }
  
    .hexagon {
        fill: none;
        stroke: #ddd;
        stroke-opacity: .4;
        pointer-events: all;
    }

    .hexagon path {
        -webkit-transition: fill 250ms linear;
        transition: fill 250ms linear;
    }

    .hexagon :hover {
        fill: #ddd;
        opacity: .5;
    }

    .hexagon .fill {
        fill: #666;
        opacity: .5;
    }
  
    .route, #arrow {  
        fill: none;
        stroke: #08f7fe;
        stroke-width: 3px;
        stroke-opacity: .9;
    }

    .border {
        fill: none;
        stroke: #000;
        stroke-width: 2px;
        pointer-events: none;
    }
  </style>

  <script src="https://d3js.org/d3.v5.min.js"></script>
  <script type="text/javascript" src="https://unpkg.com/roll-a-die@1.5.5/dist/roll-a-die.js"></script>
  <script src="hex.js"></script>
<head>

<body>
    <div class="border">
        <div id="field"></div>
    </div>

<script>
let div = document.getElementById('field')
let width = div.offsetWidth;
let height = div.offsetHeight;
let size = 23;
let layout = {orientation: layout_pointy, size: Point(size, size), origin: Point(Math.floor(width/2),Math.floor(height/2))};

let svg = d3.select('#field').append('svg')
      .attr('width', width)
      .attr('height', height);
      
svg.append('defs')
   .append('marker')
     .attr('id', 'arrow')
     .attr('markerUnits', 'userSpaceOnUse')
     .attr('orient', 'auto')
     .attr('markerHeight', '10')
     .attr('markerWidth', '12')
     .attr('refX', '11')
     .attr('refY', '5')
   .append('path')
     .attr('d', d3.line()([[0, 0], [10, 5], [0, 10]]))
;

svg.select('defs')
   .append('path')
      .attr('id', 'gravityArrow')
      .attr('d', 'M0.75 0L0.3 -0.27L0.3 -0.15L0.10 -0.15L0.10 0.15L0.3 0.15L0.3 0.27L0.75 0')
  
let line = d3.line()
    .x(d => d.x)
    .y(d => d.y);

let hex_width = Math.ceil(width / hex_col_width(layout));
let hex_height = Math.ceil(height / hex_row_height(layout));

let hexes = rect_map(hex_width, hex_height);

let starColors = [
    '#9db4ff',
    '#a2b9ff',
    '#a7bcff',
    '#aabfff',
    '#afc3ff',
    '#baccff',
    '#c0d1ff',
    '#cad8ff',
    '#e4e8ff',
    '#edeeff',
    '#fbf8ff',
    '#fff9f9',
    '#fff5ec',
    '#fff4e8',
    '#fff1df',
    '#ffebd1',
    '#ffd7ae',
    '#ffc690',
    '#ffbe7f',
    '#ffbb7b',
    '#ffbb7b'
]; // from http://www.vendian.org/mncharity/dir3/starcolor/
const starColorDist = 4;
let starRand = d3.randomIrwinHall(starColorDist);
    
function starColor() {
    return starColors[Math.floor(starRand() / starColorDist * starColors.length)];
}

let starSizeDist = d3.randomLogNormal(0.4, 0.2);

let stars = [...new Array(200)].map(() => {
    let x = Math.round(Math.random() * width);
    let y = Math.round(Math.random() * height);
    let size = Math.round(starSizeDist());
    return {x:x, y: y, size: size};
});

svg.append('g')
     .attr('class', 'starfield')
   .selectAll('circle')
     .data(stars)
   .enter().append('circle')
     .attr('cx', d => d.x)
     .attr('cy', d => d.y)
     .attr('r', d => d.size)
     .attr('stroke', 'none')
     .attr('fill', d => starColor());
    
svg.append('g')
     .attr('class', 'hexagon')
   .selectAll('path')
     .data(hexes)
   .enter().append('path')
     .attr('d', d => line(line_corners(layout, d)))
     .attr('class', JSON.stringify)
     .on('mousedown', mousedown)
     .on('mousemove', mousemove)
     .on('mouseup', mouseup);
     
svg.append('g')
     .attr('class', 'gravity');

/*
translate to center of hex, arrow points right by default, scales with hex side length
<use href="#gravityArrow" style="fill:#000;stroke:#fff;stroke-width:0.05" transform="
                  translate(102.3 119)
                  rotate(30)
                  scale(23)
                  "></use>
*/
function drawGravityArrows(gravityMap) {
    let grav = svg.select('.gravity')
        .selectAll('use')
        .data(Object.keys(gravityMap).map(eval)); // I know, I know. I'm lazy - so sue me.
       
    grav.exit().remove()
       
    grav.enter().append('use').merge(grav)
        .attr('href', '#gravityArrow')
        .attr('transform', d => {
        console.log(d);
            let res = [];
            res.push('translate(');
            let point = hex_to_pixel(layout, d);
            res.push(point.x);
            res.push(point.y);
            res.push(') rotate(');
            let hex_dir = gravityMap[d.toString()];
            let dir_index = hex_directions.findIndex(e => hex_distance(e, hex_dir) == 0);
            res.push(dir_index * 60);
            res.push(') scale(');
            res.push(layout.size.x);
            res.push(')');
            
            return res.join(' ');
        })
 
}

svg.append('g')
     .attr('class', 'route');

let start = null;
let routes = []

function mousedown(d) {
    if (hex_distance(ship.predictedPos, d) <= 1){
        start = d;
    }
}

function mousemove(d) {
//  if ((start !== null) && (d != start)) {
//    routes.push([start, d]);
//    drawLine(routes);
//    routes.pop();
//  }
  
}

function mouseup(d) {
  if ((start !== null) && (d == start)) {
    ship.acceleration = hex_subtract(d, ship.predictedPos);
  }
  start = null;
  plotPredicted(ship);
}

function drawShipRoute(ship) {
    let path = svg.select('.route')
                  .selectAll(`path.${ship.id}`)
                  .data(ship.route);
    path.exit().remove();
    
    path.enter().append('path').merge(path)
         .attr('class', ship.id)
         .attr('marker-end', 'url(#arrow)')
         .attr('d', d => line(d.map(p => hex_to_pixel(layout, p))));
}

function plotPredicted(ship) {
    let data = [];
    if (hex_distance(ship.position, newpos) > 0){
        data.push([ship.position, newpos]);
    }
    if (hex_length(ship.acceleration) > 0) {
        data.push([ship.predictedPos, hex_add(ship.predictedPos, ship.acceleration)]);
    }
    let predicted = svg.select('.route')
        .selectAll('path.predicted')
        .data(data);
       
    predicted.exit().remove()
       
    predicted.enter().append('path').merge(predicted)
        .attr('marker-end', 'url(#arrow)')
        .attr('stroke-dasharray', '10,10')
        .attr('class', 'predicted')
        .attr('d', d=> line(d.map(p => hex_to_pixel(layout, p))));
}

let ship = {
    id: 'test',
    position: Hex(0,0,0),
    velocity: Hex(0,0,0),
    predictedPos: Hex(0,0,0),
    acceleration: Hex(0,0,0),
    route: [],
    fuel: 20,
    fuelCapacity: 20,
    gravity: [],
    cargo: 5,
    str: 2,
    type: 'Corvette'
}

let gravityMap = {};
let hex0 = Hex(0,0,0);
//hex_directions.map(hex => {gravityMap[hex] = hex_subtract(hex0, hex)});

let turn = 1;
let newpos;


function astrogationPhase() {
    newpos = hex_add(ship.position, ship.velocity);
    
    if (ship.gravity.length > 0) {
        newpos = ship.gravity.reduce(hex_add, newpos);
    }
    
    ship.predictedPos = newpos;
    plotPredicted(ship);
    
    //todo: overload maneuver
}

function ordinancePhase() {
    //todo
}

function movementPhase() {
    let newpos = hex_add(ship.predictedPos, ship.acceleration);
    ship.velocity = hex_add(ship.velocity, ship.acceleration);
    ship.fuel -= hex_length(ship.acceleration);
    ship.acceleration = Hex(0,0,0);
    ship.route.push([ship.position, newpos]);
    drawShipRoute(ship);
    let hexesTraversed = hex_linedraw(ship.position, newpos);
    ship.gravity = hexesTraversed.slice(1)
        .filter(hex => hex.toString() in gravityMap)
        .map(hex => gravityMap[hex.toString()]);
    ship.position = newpos;
    newpos = null;
    
    //todo: move this out to a better place
    svg.select('.route')
        .selectAll('path.predicted')
        .data([])
       .exit().remove();
    
    //todo: collision check for astral bodies
    //todo: landing
}

function combatPhase() {
    //todo
}

function resupplyPhase() {
    //todo
}

</script>
</body>
</html>
